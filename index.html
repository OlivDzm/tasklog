<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TaskLog - Capt Dzune</title>
<link rel="manifest" href="manifest.json">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>

<style>
/* Include your current CSS exactly as it is */
body {
  font-family: Arial, sans-serif;
  background-color: var(--bg);
  color: var(--text);
  margin: 0;
  padding: 20px;
  transition: background 0.3s, color 0.3s;
}
/* ... rest of your CSS ... */
</style>
</head>

<body>
<h1>TaskLog - Capt Dzune  
  <button id="darkModeBtn" onclick="toggleDarkMode()">ðŸŒ™ Dark Mode</button>
</h1>

<input type="text" id="taskInput" placeholder="Enter a new task" />
<input type="date" id="dueDateInput" />
<select id="prioritySelect">
  <option value="high">High</option>
  <option value="medium" selected>Medium</option>
  <option value="low">Low</option>
</select>
<button id="addTaskBtn" onclick="addTask()">Add Task</button>
<button id="downloadCSVBtn" onclick="downloadCSV()">Download CSV</button>

<br>
<input type="text" id="searchInput" placeholder="Search..." oninput="filterEntries()" />

<div class="columns">
  <div class="column-left">
    <h2>Tasks</h2>
    <ul id="taskList"></ul>
    <h3>Completed Tasks</h3>
    <div id="completedTasks">
      <ul id="completedTaskList"></ul>
    </div>
  </div>

  <div class="column-right">
    <h2>Appointments</h2>
    <input type="text" id="apptInput" placeholder="Appointment description" />
    <input type="date" id="apptDateInput" />
    <input type="time" id="apptTimeInput" />
    <select id="apptPrioritySelect">
      <option value="high">High</option>
      <option value="medium" selected>Medium</option>
      <option value="low">Low</option>
      <option value="urgent">Urgent</option>
    </select>
    <button id="addApptBtn" onclick="addAppointment()">Add Appointment</button>
    <ul id="apptList"></ul>
    <h3>Completed Appointments</h3>
    <div id="completedAppointments">
      <ul id="completedApptList"></ul>
    </div>
  </div>
</div>

<script>
/* ========== FIREBASE CONFIG ========= */
const firebaseConfig = {
  apiKey: "AIzaSyCNAdaLUesH53YUMKWkX0NRAKbmcK6N4YM",
  authDomain: "tasklog-dc1fb.firebaseapp.com",
  projectId: "tasklog-dc1fb",
  storageBucket: "tasklog-dc1fb.firebasestorage.app",
  messagingSenderId: "818713885396",
  appId: "1:818713885396:web:813e478a8ee0e1ea029941"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const userId = "defaultUser"; // Simple shared user ID; later you can add login

/* ========== SAVE TO FIRESTORE ========== */
async function saveAll() {
  const data = { 
    dark: document.body.classList.contains("dark"),
    tasks: [],
    completedTasks: [],
    appts: [],
    completedAppts: []
  };

  document.querySelectorAll("#taskList li").forEach(li => {
    data.tasks.push({
      text: li.querySelector("strong").textContent,
      due: li.dataset.due || "",
      priority: li.className.replace("task-", ""),
      comment: li.querySelector("textarea").value || ""
    });
  });

  document.querySelectorAll("#completedTaskList li").forEach(li => {
    data.completedTasks.push({
      text: li.querySelector("strong").textContent,
      due: li.dataset.due || "",
      priority: li.className.replace("task-", ""),
      comment: li.querySelector("textarea").value || ""
    });
  });

  document.querySelectorAll("#apptList li").forEach(li => {
    data.appts.push({
      text: li.querySelector("strong").textContent,
      date: li.dataset.date || "",
      time: li.dataset.time || "",
      priority: li.className.replace("appt-", ""),
      comment: li.querySelector("textarea").value || ""
    });
  });

  document.querySelectorAll("#completedApptList li").forEach(li => {
    data.completedAppts.push({
      text: li.querySelector("strong").textContent,
      date: li.dataset.date || "",
      time: li.dataset.time || "",
      priority: li.className.replace("appt-", ""),
      comment: li.querySelector("textarea").value || ""
    });
  });

  try {
    await db.collection("tasks").doc(userId).set(data);
    console.log("Saved to Firebase!");
  } catch (err) {
    console.error("Save failed:", err);
  }
}

/* ========== LOAD FROM FIRESTORE ========== */
async function loadAll() {
  try {
    const doc = await db.collection("tasks").doc(userId).get();
    if (!doc.exists) return;

    const data = doc.data();
    taskList.innerHTML = "";
    completedTaskList.innerHTML = "";
    apptList.innerHTML = "";
    completedApptList.innerHTML = "";

    if (data.dark) document.body.classList.add("dark");

    (data.tasks || []).forEach(item => taskList.appendChild(createTaskLi(item,false)));
    (data.completedTasks || []).forEach(item => completedTaskList.appendChild(createTaskLi(item,true)));
    (data.appts || []).forEach(item => apptList.appendChild(createApptLi(item,false)));
    (data.completedAppts || []).forEach(item => completedApptList.appendChild(createApptLi(item,true)));

    sortTasks();
    sortAppointments();
  } catch (err) {
    console.error("Load failed:", err);
  }
}

/* ========== REST OF YOUR EXISTING FUNCTIONS ========== */
/* createTaskLi, createApptLi, addTask, addAppointment, editTask, editAppointment, etc. */
/* Use saveAll() after every change instead of localStorage */
window.onload = loadAll;

function toggleDarkMode() { document.body.classList.toggle("dark"); saveAll(); }
/* ... include all your other functions exactly as before, replacing localStorage calls with saveAll() ... */
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function () {
    navigator.serviceWorker.register('service-worker.js').catch(function (err) {
      console.log('Service worker registration failed:', err);
    });
  });
}
</script>
</body>
</html>
